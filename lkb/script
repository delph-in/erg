;;; -*- Mode: LISP; Syntax: Common-Lisp; Package: LKB -*-

(unless (lkb-version-after-p "2006/07/05 12:00:00")
  (error "this version of the ERG requires an LKB version >= 2006/07/05"))
  
(set-coding-system utf-8)

(time
 (progn
  (lkb-load-lisp (parent-directory) "Version.lisp" t)
  (setf *grammar-directory* (parent-directory))
  (load-lkb-preferences (this-directory) "user-prefs.lsp")
  (lkb-load-lisp (this-directory) "globals.lsp")
  (lkb-load-lisp (this-directory) "user-fns.lsp")
  (lkb-load-lisp (this-directory) "checkpaths.lsp" t)
  (lkb-load-lisp (this-directory) "patches.lsp" t)
  (load-irregular-spellings 
   (list
    (lkb-pathname (parent-directory) "irregs.tab")
    #+:arboretum
    (lkb-pathname (parent-directory) "arboretum/mal-irregs.tab")))
  (read-tdl-type-files-aux
   (list (lkb-pathname (parent-directory) "fundamentals.tdl")
         (lkb-pathname (parent-directory) "lextypes.tdl")
         (lkb-pathname (parent-directory) "syntax.tdl")
         (lkb-pathname (parent-directory) "lexrules.tdl")
         (lkb-pathname (parent-directory) "auxverbs.tdl")
         #+:arboretum
	 (lkb-pathname (parent-directory) "arboretum/mal-types.tdl")
         #+:mt
         (lkb-pathname (parent-directory) "mtr.tdl")
         )
   (lkb-pathname (this-directory) "settings.lsp"))
  (read-cached-leaf-types-if-available
   (list (lkb-pathname (parent-directory) "letypes.tdl")
         #+:arboretum
         (lkb-pathname (parent-directory) "arboretum/mal-letypes.tdl")))

  (if (and (boundp '*lexdb-params*) *lexdb-params*)
      (load-lexdb-from-script)
    (read-cached-lex-if-available 
     (list
      (lkb-pathname (parent-directory) "lexicon.tdl")
      (lkb-pathname (parent-directory) "gen-lex.tdl")
      (lkb-pathname (parent-directory) "handon-propers.tdl")
      #+:arboretum
      (lkb-pathname (parent-directory) "arboretum/mal-lex.tdl")
      )))

  (read-tdl-grammar-file-aux 
   (lkb-pathname (parent-directory) "constructions.tdl"))
  #+:arboretum
  (read-tdl-grammar-file-aux 
   (lkb-pathname (parent-directory) "arboretum/mal-constructions.tdl"))

  (read-morph-file-aux (lkb-pathname (parent-directory) "inflr.tdl"))
  (read-morph-file-aux (lkb-pathname (parent-directory) "inflr-pnct.tdl"))
  #+:arboretum
  (read-morph-file-aux (lkb-pathname (parent-directory) "arboretum/mal-inflr.tdl"))
  (read-tdl-psort-file-aux 
   (lkb-pathname (parent-directory) "roots.tdl"))

  (read-tdl-lex-rule-file-aux 
   (lkb-pathname (parent-directory) "lexrinst.tdl"))
  #+:arboretum
  (read-tdl-lex-rule-file-aux 
   (lkb-pathname (parent-directory) "arboretum/mal-lexrinst.tdl"))
  (read-tdl-parse-node-file-aux 
   (lkb-pathname (parent-directory) "parse-nodes.tdl"))

  (lkb-load-lisp (this-directory) "mrs-initialization.lsp" t)
 
  #+:arboretum  
  (lkb-load-lisp (parent-directory) "arboretum/errordesc.lsp" t)
  
  ;; if the preprocessor code is loaded (which it is by default)
  ;; load the finite state rules.  Documentation awaited
  (read-preprocessor (lkb-pathname (parent-directory) "preprocessor.fsr"))
  ))

#+:logon
(read-repp (lkb-pathname (parent-directory) "preprocessor-min.fsr"))
;(read-repp (lkb-pathname (parent-directory) "preprocessor.fsr"))

;;;
;;; when loaded into an environment including [incr tsdb()] and the Redwoods
;;; tools, also load a Maximum Entropy realization ranking model and activate
;;; selective unpacking (for generation).
;;;
#+(and :tsdb :logon)
(tsdb::read-model (lkb-pathname (parent-directory) "jhpstg.g.mem"))
#+(and :tsdb :logon)
(setf *unpacking-scoring-hook* #'tsdb::mem-score-configuration)

;;;
;;; the semantic interface (SEM-I), used only in batch testing (for now)
;;;
#+:logon
(mt:read-semi (lkb-pathname (parent-directory) "erg.smi"))

;;;
;;; the mapping from grammar-internal to SEM-I compliant variable properties
;;;
(mt:read-vpm (lkb-pathname (parent-directory) "semi.vpm") :semi)
;;;
;;; another variable property mapping, used only when constructing the SEM-I
;;;
(mt:read-vpm (lkb-pathname (parent-directory) "abstract.vpm") :abstract)


;;;
;;; finally, use the new transfer component: load any number of rule sets, each
;;; in a separate file, associated with its identifier.  
;;;
(lkb-load-lisp (this-directory) "mt.lsp" t)

;;;
;;; the following two rules sets could possibly be merged at some point, but
;;; for right now dan prefers keeping them separate.            (3-may-05; oe)
;;;


(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "paraphraser.mtr"))
 "MWE Paraphraser"
 :filter nil :task :paraphrase)

#|
(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "cluster.mtr"))
 "Cluster Normalizer"
 :filter nil :task :paraphrase)
|#


(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "idioms.mtr"))
 "Idiom Tests"
 :filter nil :task :idiom)

(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "generation.mtr"))
 "Generation Grammar Compliance Rules"
 :filter nil :task :comply :edges 200)

(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "trigger.mtr"))
 "Generation Trigger Rules"
 :filter nil :task :trigger :recurse nil :edges 200 :subsume nil)

#+:null
(mt:read-transfer-rules 
 (list
  (lkb-pathname (parent-directory) "semiout.mtr"))
 "SEMI example generator"
 :filter nil :task :paraphrase :recurse nil :subsume t)
